#!/bin/sh

# install-imagej: Adds ImageJ capabilities to your OMERO installation.

set -e

# -- Subroutines --

die () {
	echo "$*" >&2
	exit 1
}

download () {
	name="$1"
	url="$2"
	dest="$3"
	echo "-> downloading $name"
	curl -fs "$url" > "$dest" || die "Failed to download: $url"
}

# -- Sanity checks --

test $# = 1 ||
	die "Usage: $0 <path/to/omero>"

omero="$1"

test -f "$omero/lib/server/blitz.jar" ||
	die "Invalid OMERO installation: $omero"

if [ -e "$IMAGEJ_HOME" ]
then
	imagej="$IMAGEJ_HOME"
else
	imagej="$omero/lib/ImageJ.app"
fi

# -- Download and install ImageJ --

if [ -d "$imagej" ]
then
	echo "ImageJ installation already exists; skipping."
else (
	mkdir -p "$imagej"
	cd "$imagej"
	download ImageJ http://update.imagej.net/bootstrap.js install.js
	echo "-> installing ImageJ"
	jrunscript bootstrap.js add-update-site \
		OMERO-5.0 http://sites.imagej.net/OMERO-5.0
	jrunscript bootstrap.js update
	rm install.js
) fi

# -- Generate ImageJ scripts --

GEN_SCRIPT="genScripts.jy"
GEN_SCRIPT_URL="https://raw.github.com/imagej/imagej-omero/master/bin/$GEN_SCRIPT"
GEN_SCRIPT_PATH="$OMERO_HOME/lib/$GEN_SCRIPT"
GEN_SCRIPT_CMD="jython $GEN_SCRIPT_PATH"

download "$GEN_SCRIPT" "$GEN_SCRIPT_URL" "$GEN_SCRIPT_PATH"

echo "-> generating OMERO scripts"
(
	$GEN_SCRIPT_CMD > /dev/null &&
	echo "$(find "$OMERO_HOME/lib/scripts/imagej" | wc -l) scripts generated."
)

echo
echo "To regenerate scripts, run:"
echo "    $GEN_SCRIPT_CMD"
